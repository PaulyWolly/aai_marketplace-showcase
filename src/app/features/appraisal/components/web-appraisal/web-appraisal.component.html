<div class="web-appraisal-container">
  <div class="header">
    <h1>Web Appraisal</h1>
    <p>Get an expert appraisal for your antiques, jewelry, and vintage items using our web-based appraisal system</p>
  </div>

  <!-- Error message display -->
  <div *ngIf="appraisalError" class="error-message">
    <mat-card>
      <mat-card-header>
        <mat-icon mat-card-avatar color="warn">error</mat-icon>
        <mat-card-title>Error</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <p>{{appraisalError}}</p>
      </mat-card-content>
      <mat-card-actions>
        <button mat-raised-button color="primary" (click)="appraisalError = null">Dismiss</button>
      </mat-card-actions>
    </mat-card>
  </div>

  <!-- Step indicator -->
  <div class="step-indicator">
    <div class="step" [class.active]="processingStage === 'capture'">
      <div class="step-number">1</div>
      <div class="step-label">Capture Image</div>
    </div>
    <div class="step-connector"></div>
    <div class="step" [class.active]="processingStage === 'details'">
      <div class="step-number">2</div>
      <div class="step-label">Item Details</div>
    </div>
    <div class="step-connector"></div>
    <div class="step" [class.active]="processingStage === 'processing'">
      <div class="step-number">3</div>
      <div class="step-label">Processing</div>
    </div>
    <div class="step-connector"></div>
    <div class="step" [class.active]="processingStage === 'results'">
      <div class="step-number">4</div>
      <div class="step-label">Results</div>
    </div>
  </div>

  <!-- STAGE 1: Image Capture -->
  <div *ngIf="processingStage === 'capture'" class="capture-stage">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Capture or Upload an Image</mat-card-title>
        <mat-card-subtitle>Take a clear photo of your item or upload an existing image</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <!-- Camera selection -->
        <div *ngIf="devices.length > 0" class="camera-selection">
          <mat-form-field appearance="outline">
            <mat-label>Select Camera</mat-label>
            <mat-select [(ngModel)]="selectedDevice">
              <mat-option *ngFor="let device of devices" [value]="device.deviceId">
                {{device.label || 'Camera ' + (devices.indexOf(device) + 1)}}
              </mat-option>
            </mat-select>
          </mat-form-field>
          
          <button mat-raised-button color="primary" (click)="connectCamera()" [disabled]="!selectedDevice || isCameraActive">
            <mat-icon>camera_alt</mat-icon>
            Open Camera
          </button>
        </div>

        <!-- Webcam display -->
        <div *ngIf="showWebcam" class="webcam-container">
          <webcam
            [height]="480"
            [width]="640"
            [trigger]="triggerObservable"
            (imageCapture)="handleImage($event)"
            (initError)="handleInitError($event)"
            [videoOptions]="{
              deviceId: selectedDevice ? { exact: selectedDevice } : undefined,
              width: { ideal: 1280 },
              height: { ideal: 720 }
            }"
          ></webcam>
          
          <div class="camera-controls">
            <button mat-raised-button color="primary" (click)="triggerSnapshot()">
              <mat-icon>photo_camera</mat-icon> Capture
            </button>
            <button mat-raised-button color="warn" (click)="disconnectCamera()">
              <mat-icon>close</mat-icon> Close Camera
            </button>
          </div>
        </div>

        <!-- File upload option -->
        <div class="upload-container">
          <div class="upload-prompt">
            <p>Or upload an image from your device:</p>
            <button mat-raised-button color="accent" (click)="fileInput.click()">
              <mat-icon>upload</mat-icon>
              Upload Image
            </button>
            <input hidden type="file" #fileInput accept="image/*" (change)="onFileSelected($event)">
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- STAGE 2: Item Details -->
  <div *ngIf="processingStage === 'details'" class="details-stage">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Item Details</mat-card-title>
        <mat-card-subtitle>Provide information about your item to improve appraisal accuracy</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="image-preview">
          <img [src]="imageData" alt="Item image">
        </div>
        
        <form [formGroup]="appraisalForm" (ngSubmit)="submitAppraisal()">
          <mat-form-field appearance="outline">
            <mat-label>Item Type</mat-label>
            <mat-select formControlName="itemType" required>
              <mat-option *ngFor="let type of itemTypes" [value]="type">
                {{type}}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="appraisalForm.get('itemType')?.hasError('required')">
              Item type is required
            </mat-error>
          </mat-form-field>
          
          <mat-form-field appearance="outline">
            <mat-label>Additional Information (optional)</mat-label>
            <textarea matInput formControlName="additionalInfo" rows="4" 
                      placeholder="Provide any additional details about the item that might help with the appraisal (e.g., age, origin, history, markings, etc.)"></textarea>
          </mat-form-field>
          
          <div class="form-actions">
            <button mat-button type="button" (click)="startOver()">
              <mat-icon>arrow_back</mat-icon>
              Back
            </button>
            <button mat-raised-button color="primary" type="submit" [disabled]="appraisalForm.invalid || isSubmitting">
              <mat-spinner diameter="20" *ngIf="isSubmitting"></mat-spinner>
              <span *ngIf="!isSubmitting">Submit for Appraisal</span>
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- STAGE 3: Processing -->
  <div *ngIf="processingStage === 'processing'" class="processing-stage">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Processing Your Appraisal</mat-card-title>
        <mat-card-subtitle>Please wait while we analyze your item and gather expert opinions</mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="processing-content">
          <div class="image-preview">
            <img [src]="imageData" alt="Item image">
          </div>
          
          <div class="processing-info">
            <h3>What's happening now:</h3>
            <ul>
              <li>Analyzing image characteristics</li>
              <li>Identifying item type and features</li>
              <li>Consulting with appraisal experts</li>
              <li>Researching similar items and market values</li>
              <li>Compiling comprehensive appraisal report</li>
            </ul>
          </div>
          
          <div class="progress-container">
            <mat-progress-bar mode="determinate" [value]="processingProgress"></mat-progress-bar>
            <p class="progress-text">{{processingProgress.toFixed(0)}}% complete</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- STAGE 4: Results -->
  <div *ngIf="processingStage === 'results' && currentAppraisal" class="results-stage">
    <mat-card>
      <mat-card-header>
        <mat-card-title>Appraisal Results</mat-card-title>
        <mat-card-subtitle>
          Completed in {{currentAppraisal.processingTime}} seconds with {{currentAppraisal.sources.length}} expert sources
        </mat-card-subtitle>
      </mat-card-header>
      
      <mat-card-content>
        <div class="results-content">
          <div class="image-preview">
            <img [src]="currentAppraisal.imageUrl" alt="Item image">
          </div>
          
          <div class="appraisal-summary">
            <h2>{{currentAppraisal.aggregatedResult.suggestedName}}</h2>
            
            <div class="value-range">
              <h3>Estimated Value Range:</h3>
              <div class="value-amount">
                {{currentAppraisal.aggregatedResult.estimatedValueRange.min}} - 
                {{currentAppraisal.aggregatedResult.estimatedValueRange.max}}
              </div>
              <div class="confidence">
                Confidence: {{currentAppraisal.aggregatedResult.confidence}}%
              </div>
            </div>
            
            <div class="item-details">
              <p><strong>Category:</strong> {{currentAppraisal.aggregatedResult.suggestedCategory}}</p>
              <p><strong>Condition:</strong> {{currentAppraisal.aggregatedResult.suggestedCondition}}</p>
              <p><strong>Description:</strong> {{currentAppraisal.aggregatedResult.suggestedDescription}}</p>
            </div>
          </div>
          
          <mat-accordion class="sources-accordion">
            <mat-expansion-panel *ngFor="let source of currentAppraisal.sources">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  {{source.name}}
                </mat-panel-title>
                <mat-panel-description>
                  {{source.estimatedValue}} ({{source.confidence}}% confidence)
                </mat-panel-description>
              </mat-expansion-panel-header>
              
              <p><strong>Description:</strong> {{source.description}}</p>
              
              <div *ngIf="source.itemDetails">
                <h4>Item Details:</h4>
                <ul>
                  <li *ngFor="let detail of getItemDetails(source.itemDetails)">
                    <strong>{{detail.key}}:</strong> {{detail.value}}
                  </li>
                </ul>
              </div>
              
              <div *ngIf="source.similarItems && source.similarItems.length > 0">
                <h4>Similar Items:</h4>
                <div class="similar-items">
                  <div class="similar-item" *ngFor="let item of source.similarItems">
                    <img [src]="item.imageUrl" [alt]="item.title">
                    <div class="similar-item-details">
                      <p class="title">{{item.title}}</p>
                      <p class="price">{{item.price}}</p>
                      <a [href]="item.url" target="_blank" mat-button color="primary">View Source</a>
                    </div>
                  </div>
                </div>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>
      </mat-card-content>
      
      <mat-card-actions>
        <button mat-raised-button color="primary" (click)="saveAppraisalToSystem()">
          <mat-icon>save</mat-icon>
          Save to My Appraisals
        </button>
        <button mat-button (click)="startOver()">
          <mat-icon>refresh</mat-icon>
          Start New Appraisal
        </button>
      </mat-card-actions>
    </mat-card>
  </div>
</div> 